<!DOCTYPE html>
<html>
<head>
  <title>Talking Avatar</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 20px; }
    canvas { width: 100%; max-width: 600px; height: 500px; border: 1px solid #ccc; }
    input { padding: 10px; width: 300px; }
    button { padding: 10px 20px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Your Talking Avatar</h2>
  <input type="text" id="textInput" placeholder="Enter words for the avatar to say">
  <button onclick="speak()">Speak</button>
  <div id="avatarContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/loaders/GLTFLoader.js"></script>
  <script>
    // Setup Three.js scene
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 600 / 500, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(600, 500);
    document.getElementById('avatarContainer').appendChild(renderer.domElement);

    // Load a reliable avatar (publicly hosted on Glitch)
    const loader = new THREE.GLTFLoader();
    loader.load('https://cdn.glitch.com/1b6e6e2d-9e5b-4a0a-9f5e-6b1b6e2d9e5b%2Favatar.glb', (gltf) => {
      console.log('Avatar loaded successfully');
      const avatar = gltf.scene;
      scene.add(avatar);
      avatar.position.set(0, -1, 0);
      avatar.scale.set(2, 2, 2);
    }, (progress) => {
      console.log('Loading progress:', progress.loaded / progress.total * 100 + '%');
    }, (error) => {
      console.error('Avatar load error:', error);
    });

    const light = new THREE.AmbientLight(0xffffff);
    scene.add(light);
    camera.position.z = 5;

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    // ttsMP3.com TTS and basic lip sync
    const audio = new Audio();
    let mouthOpen = false;
    let lipSyncInterval;

    async function speak() {
      const text = document.getElementById('textInput').value || "Hello, Iâ€™m your avatar!";
      console.log('Generating audio with ttsMP3.com:', text);

      // ttsMP3.com requires a POST request to generate audio
      try {
        const response = await fetch('https://ttsmp3.com/makemp3_new.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            'msg': text,
            'lang': 'Joanna',  // A decent, free voice
            'source': 'ttsmp3'
          })
        });
        const data = await response.json();
        console.log('ttsMP3.com response:', data);

        if (data.URL) {
          audio.src = data.URL;
          audio.play();

          // Basic lip sync
          audio.onplay = () => {
            console.log('Audio playing');
            lipSyncInterval = setInterval(() => {
              mouthOpen = !mouthOpen;
              scene.traverse((child) => {
                if (child.isMesh) child.scale.y = mouthOpen ? 1.05 : 1;  // Crude mouth flap
              });
            }, 200);
          };
          audio.onended = () => {
            console.log('Audio ended');
            clearInterval(lipSyncInterval);
          };
        } else {
          console.error('No audio URL in response:', data);
          alert('Failed to generate audio. Check console for details.');
        }
      } catch (error) {
        console.error('Error with ttsMP3.com:', error);
        alert('Failed to generate audio. Check console for details.');
      }
    }
  </script>
</body>
</html>
